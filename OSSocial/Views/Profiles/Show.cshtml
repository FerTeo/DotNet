@model OSSocial.Models.ApplicationUser
@using System.Linq

@{
    string initial = !string.IsNullOrEmpty(Model.UserName) ? Model.UserName.Substring(0, 1).ToUpperInvariant() : "?";

    var targetId = Model.Id; 
    var isFollowing = ViewBag.IsFollowing as bool? ?? false;
    var isPending = ViewBag.IsPending as bool? ?? false;
    var showFollowButton = ViewBag.ShowFollowButton as bool? ?? false;
    var followersCount = ViewBag.FollowersCount as int? ?? 0;
    var followingCount = ViewBag.FollowingCount as int? ?? 0;
    var postCount = Model.Posts.Count as int? ?? 0;
    var showPosts = ViewBag.ShowPosts as bool? ?? false;
}

<link rel="stylesheet" href="~/css/profile_picture.css" />

@* TempData messages *@
@if (TempData["Message_Profile"] != null)
{
    <div class="alert alert-success" role="alert">@TempData["Message"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger" role="alert">@TempData["Error"]</div>
}

<div class="profile-card">
    <div class="card-body d-flex gap-4 align-items-center">
        @if (!string.IsNullOrEmpty(Model.ProfileImageUrl))
        {
            <div class="avatar-circle" aria-hidden="true">
                <img src="@Url.Content(Model.ProfileImageUrl)" alt="Profile image" class="avatar-img" />
            </div>
        }
        else
        {
            <div class="avatar-circle" aria-hidden="true">@initial</div>
        }

        <div class="flex-grow-1">
            <h3 class="mb-1">@Model.DisplayName</h3>

            <div class="mb-3 d-flex gap-3 align-items-center">
                <div><span class="meta-label">Followers: </span> <strong>@followersCount</strong></div>
                <div><span class="meta-label">Following: </span> <strong>@followingCount</strong></div>
                <div><span class="meta-label">Posts: </span> <strong>@postCount</strong></div>
            </div>

            <div class="mb-2">
                <div><span class="meta-label">Username: </span> @(!string.IsNullOrEmpty(Model.UserName) ? Model.UserName : "—")</div>
            </div>

            <div class="mb-2">
                <div><span class="meta-label">Bio: </span>@(!string.IsNullOrEmpty(Model.Bio) ? Model.Bio : "—")</div>
            </div>
        </div>
    </div>
    
    
    <div class="d-flex flex-column align-items-center justify-content-center text-center text-muted" style="max-width:720px; margin:auto; padding: 24px;">
        @if (showFollowButton)
        {
            @if (isPending)
            {
                <button class="btn btn-outline-secondary" disabled>Requested</button>
            }
            else if (isFollowing)
            {
                <form asp-controller="Follow" asp-action="Unfollow" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="targetId" value="@targetId" />
                    <button type="submit" class="btn btn-outline-danger">Unfollow</button>
                </form>
            }
            else
            {
                <form asp-controller="Follow" asp-action="Follow" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="targetId" value="@targetId" />
                    <button type="submit" class="btn btn-primary">Follow</button>
                </form>
            }
        }
    </div>
    
</div>
<hr>
@if (showPosts==true)
{
    <div class="mt-4">
        <h4 class="text-center mb-4">Posts</h4>

        @if (Model.Posts != null && Model.Posts.Any())
        {
            // Le ordonam descrescator dupa timp (cele mai noi primele)
            @foreach (var postare in Model.Posts.OrderByDescending(p => p.Time))
            {
                <div class="card mb-3" style="max-width: 720px; margin: auto;">
                    <div class="card-body">
                        <h5 class="card-title">@postare.Title</h5>
                        <p class="card-text">@postare.Content</p>
                    
                    @* Logica pentru afisare Media (Video sau Imagine) *@
                    @if (!string.IsNullOrEmpty(postare.Media))
                    {
                        <div class="mb-3">
                            @if (postare.Media.EndsWith(".mp4") || postare.Media.EndsWith(".mov"))
                            {
                                <video width="100%" height="auto" controls style="max-height: 400px; border-radius: 10px;">
                                    <source src="@postare.Media" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            }
                            else
                            {
                                <img src="@postare.Media" alt="Post Image" style="width: 100%; height: auto; object-fit: cover; border-radius: 10px; max-height: 500px;" />
                            }
                        </div>
                    }

                    <p class="text-muted small">
                        Posted: @postare.Time
                    </p>
                    
                        @* Butoane de actiune (daca vrei sa le pui si aici) *@
                        <a href="/Post/Details/@postare.Id" class="btn btn-sm btn-info text-white">View Details</a>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="text-center text-muted">
                <p>This user hasn't posted anything yet.</p>
            </div>
        
        }
    </div>

}
else
{
    
    <div class="d-flex flex-column align-items-center justify-content-center text-center text-muted" style="max-width:720px; margin:auto; padding: 24px;">

        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" class="bi bi-lock mb-2" viewBox="0 0 16 16" aria-hidden="true">
            <path fill-rule="evenodd" d="M8 0a4 4 0 0 1 4 4v2.05a2.5 2.5 0 0 1 2 2.45v5a2.5 2.5 0 0 1-2.5 2.5h-7A2.5 2.5 0 0 1 2 13.5v-5a2.5 2.5 0 0 1 2-2.45V4a4 4 0 0 1 4-4M4.5 7A1.5 1.5 0 0 0 3 8.5v5A1.5 1.5 0 0 0 4.5 15h7a1.5 1.5 0 0 0 1.5-1.5v-5A1.5 1.5 0 0 0 11.5 7zM8 1a3 3 0 0 0-3 3v2h6V4a3 3 0 0 0-3-3"/>
        </svg> @*lacat bootstrap*@

        <div>
            <p class="mb-0">Private User</p>
        </div>
    </div>
}

@* daca esti utilizatorul curent poti posta de aici *@
@if (ViewBag.IsCurrentUser == true)
{
    <a asp-controller="Post" 
       asp-action="CreatePost" 
       class="btn btn-dark shadow"
       style="
           position: fixed; 
           bottom: 100px; 
           left: 50%; 
           transform: translateX(-50%); 
           width: 60px; 
           height: 60px; 
           border-radius: 50%; 
           font-size: 35px; 
           display: flex; 
           align-items: center; 
           justify-content: center; 
           z-index: 1000;
           padding: 0;
           line-height: 1;">
        +
    </a>
}



